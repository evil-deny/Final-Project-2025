name: MMSP Final Project – Build & Run

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3

    - name: Build encoder / decoder
      run: |
        gcc encoder.c -O2 -Wall -lm -o encoder
        gcc decoder.c -O2 -Wall -lm -o decoder
        chmod +x encoder decoder

    # ⭐ 關鍵修正：讓 system("encoder ...") 找得到
    - name: Add current directory to PATH
      run: |
        echo "$(pwd)" >> $GITHUB_PATH

    # --------------------------------------------------
    # Method 0（照你給的）
    # --------------------------------------------------
    - name: Run Method 0
      run: |
        ./encoder 0 Kimberly.bmp R.txt G.txt B.txt dim.txt
        ./decoder 0 ResKimberly.bmp R.txt G.txt B.txt dim.txt
        diff Kimberly.bmp ResKimberly.bmp || true

    # --------------------------------------------------
    # Method 1（照你給的）
    # --------------------------------------------------
    - name: Run Method 1
      run: |
        ./encoder 1 Kimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw eF_Y.raw eF_Cb.raw eF_Cr.raw

        ./decoder 1 QResKimberly.bmp Kimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw
        ./decoder 1 ResKimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw eF_Y.raw eF_Cb.raw eF_Cr.raw

        diff Kimberly.bmp ResKimberly.bmp || true

    # --------------------------------------------------
    # Method 2（照你給的）
    # --------------------------------------------------
    - name: Run Method 2
      run: |
        ./encoder 2 Kimberly.bmp ascii rle_code.txt
        ./decoder 2 QResKimberly.bmp ascii rle_code.txt

        ./encoder 2 Kimberly.bmp binary rle_code.bin
        ./decoder 2 QResKimberly.bmp binary rle_code.bin

    # --------------------------------------------------
    # Method 3（照你給的，這次會跑）
    # --------------------------------------------------
    - name: Run Method 3
      run: |
        ./encoder 3 Kimberly.bmp ascii codebook.txt huffman_code.txt
        ./decoder 3 QResKimberly.bmp ascii codebook.txt huffman_code.txt

        ./encoder 3 Kimberly.bmp binary codebook.txt huffman_code.bin
        ./decoder 3 QResKimberly.bmp binary codebook.txt huffman_code.bin

    # --------------------------------------------------
    # Upload artifacts（不自己壓縮）
    # --------------------------------------------------
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: MMSP_Final_Project_Output
        path: |
          *.bmp
          *.txt
          *.raw
          *.bin
