name: MMSP Final Project – Complete Pipeline (Method 0–3)

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
    # --------------------------------------------------
    # 1. Checkout
    # --------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # --------------------------------------------------
    # 2. Install dependencies
    # --------------------------------------------------
    - name: Install build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential python3

    # --------------------------------------------------
    # 3. Build encoder / decoder
    # --------------------------------------------------
    - name: Compile C Code
      run: |
        echo "Compiling encoder / decoder..."
        gcc encoder.c -O2 -Wall -lm -o encoder
        gcc decoder.c -O2 -Wall -lm -o decoder
        chmod +x encoder decoder

    # --------------------------------------------------
    # 4. Prepare test BMP (Kimberly.bmp)
    # --------------------------------------------------
    - name: Prepare test BMP
      run: |
        python3 << 'EOF'
        import struct

        W, H = 8, 8
        row_size = ((W*3+3)//4)*4
        img_size = row_size * H
        file_size = 54 + img_size

        header = struct.pack("<2sIHHI", b"BM", file_size, 0, 0, 54)
        info = struct.pack(
            "<IIIHHIIIIII",
            40, W, H, 1, 24, 0,
            img_size, 3780, 3780, 0, 0
        )

        with open("Kimberly.bmp","wb") as f:
            f.write(header)
            f.write(info)
            for y in range(H):
                row = bytearray()
                for x in range(W):
                    row += bytes([x*30, y*30, 128])
                row += b'\x00' * (row_size - W*3)
                f.write(row)
        EOF

    # --------------------------------------------------
    # 5. Method 0
    # --------------------------------------------------
    - name: Run Method 0
      run: |
        echo "===== Method 0 ====="
        ./encoder 0 Kimberly.bmp R.txt G.txt B.txt dim.txt
        ./decoder 0 ResKimberly.bmp R.txt G.txt B.txt dim.txt

        echo "Diff check (Method 0):"
        diff Kimberly.bmp ResKimberly.bmp || echo "Method 0: diff exists (expected if lossy)"

    # --------------------------------------------------
    # 6. Method 1
    # --------------------------------------------------
    - name: Run Method 1
      run: |
        echo "===== Method 1 ====="
        ./encoder 1 Kimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt \
          qF_Y.raw qF_Cb.raw qF_Cr.raw eF_Y.raw eF_Cb.raw eF_Cr.raw

        ./decoder 1 ResKimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt \
          qF_Y.raw qF_Cb.raw qF_Cr.raw eF_Y.raw eF_Cb.raw eF_Cr.raw

        echo "Diff check (Method 1):"
        diff Kimberly.bmp ResKimberly.bmp || echo "Method 1: diff exists (expected)"

    # --------------------------------------------------
    # 7. Method 2 (ascii + binary)
    # --------------------------------------------------
    - name: Run Method 2
      run: |
        echo "===== Method 2 (ascii) ====="
        ./encoder 2 Kimberly.bmp ascii rle_code.txt
        ./decoder 2 QResKimberly.bmp ascii rle_code.txt

        echo "===== Method 2 (binary) ====="
        ./encoder 2 Kimberly.bmp binary rle_code.bin
        ./decoder 2 QResKimberly.bmp binary rle_code.bin

    # --------------------------------------------------
    # 8. Method 3 (depends on Method 2 binary)
    # --------------------------------------------------
    - name: Run Method 3
      run: |
        echo "===== Method 3 ====="

        # 明確先確保 Method 2 binary 已存在
        ./encoder 2 Kimberly.bmp binary rle_code.bin

        echo "--- Method 3 ascii ---"
        ./encoder 3 Kimberly.bmp ascii codebook.txt huffman_code.txt
        ./decoder 3 QResKimberly.bmp ascii codebook.txt huffman_code.txt

        echo "--- Method 3 binary ---"
        ./encoder 3 Kimberly.bmp binary codebook.txt huffman_code.bin
        ./decoder 3 QResKimberly.bmp binary codebook.txt huffman_code.bin

    # --------------------------------------------------
    # 9. Upload artifacts
    # --------------------------------------------------
    - name: Upload Results (Artifacts)
      uses: actions/upload-artifact@v4
      with:
        name: mmsp-final-results
        path: |
          *.bmp
          *.txt
          *.bin
          *.raw
